{% extends 'base.html' %}
<!--  -->
{% block title %} Log in | {% endblock %}
<!--  -->
{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="/static/style.css" />

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Responsive Webpage</title>
  </head>
  <body>
    <header>
  <!-- 버튼과 해당 내용을 함께 감싸는 div 추가 -->
  <div class="button-content-container">
    <div class="button-container">
        <button onclick="showProfile()" id="userProfileBtn">
            user_profile
        </button>
        <button onclick="showUsersStatus()" id="userStatusBtn">
            user_status
        </button>
    </div>
    <div class="content-container"> 
        <div id="UserProfileAndStatus">
          <!-- 버튼 클릭시내용들 추가 -->
        </div>
    </header>

    <div id="onlineUserLabel">Currently Logged In Users</div>
    <div id="userListContainer">
      <ul id="userList">
        <!-- 사용자 목록은 여기에 표시됩니다. -->
      </ul>
    </div>

    <div id="pongGame">
      <div id="gameTitle">PONG GAME</div>
      <div id="gameOptions">
        <button id="withComputerBtn">with_computer</button>
        <button id="withUsersBtn">with_users</button>
      </div>
    </div>

    <div style="display: flex; align-items: center">
      <a href="{% url 'chatting:rooms' %}" id="joinChatButton" class="button"
        >Join Chatting Room</a
      >
    </div>
    <div id="liveChatLabel" class="ml-3">1:1 Live_Chat</div>
    <div id="chatContainer">
      <!-- Chat contents here -->
    </div>

    <script>
      // 컴퓨터와 핑퐁 게임하는 화면으로 넘어가는 이벤트
      document.addEventListener("DOMContentLoaded", function () {
        var withComputerBtn = document.getElementById("withComputerBtn");
        withComputerBtn.addEventListener("click", function () {
          window.location.href = "{% url 'ft_user:pong_with_computer' %}"; // 이동할 페이지의 경로를 넣어주세요.
        });
      });

      // 주기적으로 서버에 사용자 목록 요청을 보내고 화면을 업데이트하는 함수
      function updateUserList() {
        $.ajax({
          url: "/current_users_api/",
          success: function (response) {
            // 서버로부터 받은 사용자 목록을 화면에 업데이트
            var userList = response.current_users;
            var userListHTML = "";
            for (var i = 0; i < userList.length; i++) {
              var userId = "user_" + i;
              // 클릭 가능한 사용자 목록 생성
              userListHTML +=
                '<li id="' +
                userId +
                '" onclick="handleUserClick(\'' +
                userList[i] +
                "')\">" +
                userList[i] +
                "</li>";
            }
            $("#userList").html(userListHTML);
          },
        });
      }

      // 페이지 로드 후 초기 사용자 목록 업데이트
      $(document).ready(function () {
        updateUserList();
        // 1초마다 사용자 목록 업데이트
        setInterval(updateUserList, 10000);
      });

      // 사용자를 클릭했을 때 실행되는 함수

      function handleUserClick(username) {
        $.ajax({
          url: "/get_current_login_user_data/", // JSON 데이터를 제공하는 서버의 URL
          method: "GET",
          success: function (response) {
            // 서버로부터 받은 JSON 데이터를 이용하여 팝업 창에 표시할 내용 구성
            var currentUsername = response.username;

            // 현재 사용자 이름을 사용하여 필요한 작업을 수행
            var r = [username, currentUsername].sort();
            var sortedRoomname = r[0] + "_" + r[1];
            alert("click!");
            $.ajax({
              url: "{% url 'chatting:room_make_or_get' %}",
              type: "POST",
              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
              },
              data: {
                room_name: sortedRoomname,
                // 다른 필요한 데이터도 함께 전달할 수 있습니다.
              },
              success: function (response) {
                if (response.room_created) {
                  // 새로운 룸이 생성된 경우 채팅방 URL로 리디렉션
                  alert("success");
                  window.location.href = response.chat_room_url;
                } else {
                  // 기존에 있는 룸이 반환된 경우 해당 URL로 리디렉션
                  alert("fail");
                  window.location.href = response.chat_room_url;
                }
              },
              error: function (xhr, status, error) {
                alert("error_fail");
                // 채팅방 생성에 실패한 경우 처리
                console.error("Failed to create chat room:", error);
              },
            });
          },
          error: function (xhr, status, error) {
            // 에러 처리
            console.error(error);
          },
        });
      }

      function showProfile() {
        // AJAX 요청을 이용하여 현재 로그인한 사용자의 정보를 서버에서 가져옴
        $.ajax({
          url: "/get_current_user_data/", // JSON 데이터를 제공하는 서버의 URL
          method: "GET",
          success: function (response) {
            // 서버로부터 받은 JSON 데이터를 이용하여 팝업 창에 표시할 내용 구성
            var profileContent = "<h2>User Profile  and Game status </h2>";
            profileContent += "<p>Username: " + response.username + "</p>";
            profileContent += "<p>Email: " + response.email + "</p>";

            // GameStat 정보가 있을 경우 추가 #seycheon_0513
            if (response.game_stat) {
                profileContent = "<h2>=======Game Stat for " + response.username + "========</h2>" //seycheon_0513
                profileContent += "<p>Game Count: " + response.game_stat.game_count + "</p>";
                profileContent += "<p>Win Count: " + response.game_stat.win_count + "</p>";
                profileContent += "<p>Defeat Count: " + response.game_stat.defeat_count + "</p>";
                profileContent += "<p>Win Rate: " + response.game_stat.win_rate + "</p>";
                profileContent += "<p>Reflect Rate: " + response.game_stat.reflect_rate + "</p>";
            } else {
                profileContent += "<p>No game stat available</p>";
            }
            // 기타 필요한 사용자 정보를 추가할 수 있음
            document.getElementById("UserProfileAndStatus").innerHTML = profileContent;
          },
          error: function (xhr, status, error) {
            // 에러 처리
            console.error(error);
          },
        });
      }

      // 사용자 목록 필터링 함수
      function filterUsers() {
        var input, filter, ul, li, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        ul = document.getElementById("statUserList"); //seycheon_0513 수정
        li = ul.getElementsByTagName("li");
        for (i = 0; i < li.length; i++) {
          txtValue = li[i].textContent || li[i].innerText;
          // 사용자 이름과 입력된 문자열을 대소문자 구분 없이 비교하여 일치하는 경우에만 표시
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = ""; // 일치하는 경우 보이기
          } else {
            li[i].style.display = "none"; // 일치하지 않는 경우 숨기기
          }
        }
      }
      
    //seycheon_0513
    function showUserGameStatDetails(username) {
        // AJAX 요청을 이용하여 해당 사용자의 정보를 서버에서 가져옴
        $.ajax({
            url: "/get_user_gamestat_details/", // 해당 사용자의 정보를 제공하는 서버의 URL
            method: "GET",
            data: {
                username: username, // 클릭한 사용자의 username을 서버에 전달
            },
            success: function (response) {
                // 서버로부터 받은 JSON 데이터를 이용하여 사용자의 정보를 표시
                var userDetailsContent = "<hr>"; // 구분선 추가
                userDetailsContent += "<h3>=======User Details for " + username + "=======</h3>";  //seycheon_0513
                // 사용자의 게임 스탯 정보 추가
                if (response.game_stat) {
                    userDetailsContent += "<p>Game Count: " + response.game_stat.game_count + "</p>";
                    userDetailsContent += "<p>Win Count: " + response.game_stat.win_count + "</p>";
                    userDetailsContent += "<p>Defeat Count: " + response.game_stat.defeat_count + "</p>";
                    userDetailsContent += "<p>Win Rate: " + response.game_stat.win_rate + "</p>";
                    userDetailsContent += "<p>Reflect Rate: " + response.game_stat.reflect_rate + "</p>";
                } else {
                    userDetailsContent += "<p>No game stat available</p>";
                }
                // 사용자의 최근 10개의 매치 정보 추가
                userDetailsContent += "<h4>=======Recent Matches=======</h4>";
                userDetailsContent += "<ul>";
                response.recent_matches.forEach(function (match) {
                    userDetailsContent += "<li>Match Date: " + match.match_date + ", Result: " + match.match_result + "</li>";
                });
                userDetailsContent += "</ul>";
                // 사용자 정보를 statusUserList 목록 아래에 추가
                $("#UserGameStatDetail").append(userDetailsContent);
            },
            error: function (xhr, status, error) {
                // 에러 처리
                console.error(error);
            },
        });
    }

      //seycheon_0513
      function clearDetails() {
        document.getElementById("UserGameStatDetail").innerHTML= "";
      }
      

      //seycheon_0513
      // user_status 을 눌렀을 때 나오는 search 검색 버튼 클릭 시 해당 사용자의 세부 정보를 보여주는 함수
      function searchUsers() {
        var searchInput = document.getElementById("searchInput");
        var username = searchInput.value.trim(); // 검색어 가져오기
        if (username === "") {
          // 검색어가 비어있는 경우
          alert("Please enter a username to search."); // 사용자 이름을 입력하라는 알림 표시
          return; // 함수 종료
        }
        showUserGameStatDetails(username); // 검색어를 사용하여 사용자의 세부 정보를 보여줌
      }
  

      //seycheon_0513
      // user_status 버튼 클릭시 보이는 것
      var userData = JSON.parse("{{ users_json|escapejs }}"); // JSON 데이터를 JavaScript 변수에 할당
      function showUsersStatus() {

        // 팝업 창에 표시할 내용 구성 (검색 기능과 사용자 목록)
        var statusContent = "<h2>User Status</h2>";
        statusContent +=
          '<input type="text" id="searchInput" oninput="filterUsers()" placeholder="Search for users...">';
        // showUsersStatus 함수에서 검색창 옆에 버튼을 추가하는 부분입니다.
        statusContent +=
          '<button id="searchButton" onclick="searchUsers()">Search</button>'; // 검색 버튼 추가
        statusContent +=
          '<button id="clearButton" onclick="clearDetails()">clear</button>'; // 검색 버튼 추가
        statusContent += '<div id="statUserListContainer">'; // 스크롤이 적용될 컨테이너
        statusContent += '<ul id="statUserList">'; // UserList->statusUserList 로 이름 변경
          userData.forEach(function (user) {
            statusContent += '<li>' + user.username + '</li>';
        });
        statusContent += "</ul>";
        statusContent += '<div id="UserGameStatDetail">';
        statusContent += "</div>"; // 컨테이너 종료
        document.getElementById("UserProfileAndStatus").innerHTML = statusContent;
      }
    </script>
  </body>

  {% endblock%}
</html>
